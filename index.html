<!--2023.01.30 Hannim-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuoteMaker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js" integrity="sha512-WFN04846sdKMIP5LKNphMaWzU7YpMyCU245etK3g/2ARYbPK9Ub18eG+ljU96qKRCWh+quCY7yefSmlkQw1ANQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        h1,p{
            display: inline;
        }

        .container{
            width: 100vw;
            height: 100vh;
            display: grid;
            grid-template-columns: 1fr;
        }

        .pikaCanva{
            width: 100%;
            height: 100%;
        }

        .item1{
            width: 100%;
            height: 100%;
        }

        .itemContainer{
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="pikaCanva">
            <canvas id="canvas"></canvas>
        </div>
        <div class="item1">
            <h1>INPUT</h1>
            <p id="pblock"><!--<label for="pblock">Íµ¨Î∂ÑÏûê ÏÑ†ÌÉù üëâ </label>-->
                    <input type="radio" id="enter" name="group" value="ÏóîÌÑ∞" checked> <label for="enter">ÏóîÌÑ∞</label>
                    <input type="radio" id="comma" name="group" value="ÏΩ§Îßà"> <label for="comma">ÏΩ§Îßà</label>
                    <button>Î¶¨ÏÖã</button>
                    <label id="lblPika"></label>
            </p>
            <br><br>
            <textarea name="taOrigin" id="taOrigin" cols="50" rows="10"></textarea>
        </div>

        <div class="itemContainer">
            <div class="item2">
                <h1>OUTPUT</h1>
                <p id="pCount"></p>
                <br><br>
                <textarea name="taNew" id="taNew" cols="70" rows="20"></textarea>
            </div>
        
            <div class="item3">
                <h1>CUSTOM</h1>
                <p id="pblock"><!--<label for="pblock">ÏÑ†ÌÉù üëâ </label>-->
                    <input type="radio" id="username" name="group2" value="ÎÑ§ÏûÑ" checked> <label for="username">UserName</label>
                    <input type="radio" id="userid" name="group2" value="ÏïÑÏù¥Îîî"> <label for="userid">UserId</label>
                </p>
                <br><br>
                <textarea name="taCus" id="taCus" cols="70" rows="20"></textarea>
            </div>
        </div>
        
    </div>

</body>
<script type="text/javascript">
    let origin = document.querySelector('#taOrigin'); //INPUT textarea
    let newOutput = document.querySelector('#taNew'); //OUTPUT textarea
    let newCustom = document.querySelector('#taCus'); //CUSTOM textarea
    let radios = document.querySelectorAll('input[type=radio][name="group"]'); //Íµ¨Î∂ÑÏûê ÏÑ†ÌÉù ÎùºÎîîÏò§
    let radios2 = document.querySelectorAll('input[type=radio][name="group2"]'); //ÏÑ†ÌÉù ÎùºÎîîÏò§
    let reset = document.querySelector('#pblock > button'); //Î¶¨ÏÖãÎ≤ÑÌäº
    let outputCount = document.querySelector('#pCount'); //OUTPUT Í∞úÏàò
    let pikalabel = document.querySelector('#lblPika');

    let test = document.querySelector('#test');

    changePlaceholer(); //ÌîåÎ†àÏù¥Ïä§ÌôÄÎçî ÏÑ∏ÌåÖ

    origin.addEventListener('input', function(){
        changeQuote(origin.value);
    });

    reset.addEventListener('click', function(){
        deleteAll();

        if(pikas){
            //pika.jumpingDecision();
            //pikas = [new Pikachu()];
            _.map(pikas, pika => pika.jumpingDecision());
        }
    });

    _.map(radios, x => 
        x.addEventListener('change', function(){
            changeQuote(origin.value);
        })
    );

    _.map(radios2, x => 
        x.addEventListener('change', function(){
            customQuery(newOutput.value);
        })
    );

    //ÏòàÏ†ú ÏÑ∏ÌåÖ
    function changePlaceholer(){
        if(radios[0].checked){
            origin.placeholder = 'ÏóîÌÑ∞(New line)Î•º Íµ¨Î∂ÑÏûêÎ°ú Í∞íÏùÑ Î∂ÑÎ¶¨Ìï©ÎãàÎã§\r\n\nvalue1\r\nvalue2\r\nvalue3\r\n....\r\n...\r\n..\r\n.';
        } else{
            origin.placeholder = 'ÏΩ§ÎßàÎ•º Íµ¨Î∂ÑÏûêÎ°ú Í∞íÏùÑ Î∂ÑÎ¶¨Ìï©ÎãàÎã§\r\n\nüëâ value1, value2, value3...';
        }
    }

    //ÏûëÏùÄ Îî∞Ïò¥ÌëúÎûë ÏΩ§Îßà Î∂ôÏù¥Í∏∞
    function changeQuote(val){
        changePlaceholer();

        if(val){
            let str = _.replace(val, / /g, '');
            let splitter = ',';
            if(document.querySelector('#enter').checked){
                splitter = '\n';
            } else{
                str = _.replace(str, /(?:\r\n|\r|\n)/g, '');
            }

            let split  = _.compact(_.split(str, splitter));
            let newStr = _.map(split, x => '\'' + x + '\'\n');
            
            newOutput.value = _.trimEnd(newStr);//.replace(/\n+$/,''); //ÎßàÏßÄÎßâ ÏóîÌÑ∞Ï†úÍ±∞

            outputCount.innerText = 'üíÅ‚Äç‚ôÄÔ∏è' + beCool(split.length);
            customQuery(newOutput.value);
        } else{
            deleteAll();
        }
    }

    //ÏøºÎ¶¨ ÎßåÎì§Í∏∞
    function customQuery(val){
        if(!val)return;

        let username = document.querySelector('#username');
        let cond = username.checked?'UserName':'UserId';
        let split = _.split(val, '\n');
        let rst = _.map(split, (x, y) => (_.eq(y, 0)?'\t':'') + _.replace(x, ',', '') + '\n\t'); //0Î≤àÏß∏ÏóêÎßå ÌÉ≠ÏùÑ ÎÑ£Í≥† ÏãúÏûëÌï®
        let query = 
`SELECT
\t*
FROM HBEdu_Passport.dbo.uIv_Statistics_User AS us WITH(NOLOCK)
WHERE ${cond} IN (
${_.trimEnd(rst)}
)`;

        newCustom.value = query;
    }

    //ÏûÖÎ†•Í∞í Î©ãÏûàÍ≤å Î∞òÌôò
    function beCool(val) {
        if (val === undefined 
            || val === null 
            || val === '') {
            return val;
        }

        if (typeof val !== 'string') {
            val = val.toString();
        }

        if (val === '10') {
            return 'üîü';
        }

        return val
        .replace(/0/g, '0Ô∏è‚É£')
        .replace(/1/g, '1Ô∏è‚É£')
        .replace(/2/g, '2Ô∏è‚É£')
        .replace(/3/g, '3Ô∏è‚É£')
        .replace(/4/g, '4Ô∏è‚É£')
        .replace(/5/g, '5Ô∏è‚É£')
        .replace(/6/g, '6Ô∏è‚É£')
        .replace(/7/g, '7Ô∏è‚É£')
        .replace(/8/g, '8Ô∏è‚É£')
        .replace(/9/g, '9Ô∏è‚É£');
  }

    //Ìú¥ÏßÄÌÜµ
    function deleteAll(){
            origin.value = '';
            newOutput.value = '';
            newCustom.value = '';
            outputCount.innerText = '';
    }

    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');
    let arrayBuffer;
    const img = new Image();

    var timer = 0; //ÌÉÄÏù¥Î®∏
    
    fetch('https://raw.githubusercontent.com/jeanguyomarch/pikalogy/master/images/pika_01.png')
    .then(response => response.blob())
    .then(blob => blob.arrayBuffer())
    .then(arrayBuffer => {
        const newBlob = new Blob([arrayBuffer], { type: 'image/png' });
        const url = URL.createObjectURL(newBlob);
        img.src = url;
        //console.log(url);
    })
    .catch(error => {
        img.src = 'https://raw.githubusercontent.com/jeanguyomarch/pikalogy/master/images/pika_01.png'; 
    });

    
    class Pikachu{
        constructor(){
            this.x = 0; //ÌîºÏπ¥Ï∏Ñ xÏ¢åÌëú
            this.y = 60; //ÌîºÏπ¥Ï∏Ñ yÏ¢åÌëú
            this.width = 30; //ÌîºÏπ¥Ï∏Ñ Í∏∏Ïù¥
            this.height = 30; //ÌîºÏπ¥Ï∏Ñ ÎÜíÏù¥
            this.speed = 1; //ÏÜçÎèÑ
            this.angle = 0; //ÌöåÏ†ÑÍ∞Å
            this.lucky = false; //ÎèåÏïÑÏù¥
            this.superLucky = false; //ÏÉÅÎèåÏïÑÏù¥

            this.jumpPoint = 80; //Ï†êÌîÑÌï† ÏãúÍ∞Ñ
            this.jumpTimer = 0; //Ï†êÌîÑÏ§ë ÌÉÄÏù¥Î®∏
            this.jumpSwitch = false; //Ï†êÌîÑÌï†ÏßÄÎßêÏßÄ
            this.IsJumping = false; //Ï†êÌîÑÏ§ëÏù∏ÏßÄ

            this.hero = false;
            this.name = 'Ï°∞ÏÉÅÎãò';
        }

        //Í∑∏Î†§Îùº
        draw(){
            img.onload = () => {
                ctx.drawImage(img, this.x - this.width, this.y);
            }

            ctx.font = 'bold 13px ÎßëÏùÄÍ≥†Îîï';
            
            if(this.hero){
                //ctx.fillRect(this.x - this.width, this.y, 30, 30);
                ctx.fillText('ÎßâÎë•Ïù¥', this.x - this.width + 5, this.y - 3);
            } else{
                if(_.size(this.name) > 0) {
                    ctx.fillText(this.name, this.x - this.width, this.y - 3);
                }
            }
            
            ctx.drawImage(img, this.x - this.width, this.y);
            
        }

        //ÎèåÏïÑÎùº
        rotate(){
            if(this.superLucky){
                this.angle++; //Îπ†Î•∏ÌöåÏ†Ñ
            } else {
                this.angle+= Math.PI / 18; //ÎäêÎ¶∞ÌöåÏ†Ñ
            }
            
            ctx.save();
            ctx.translate(this.x - this.width, this.y);
            ctx.rotate(this.angle);
            ctx.drawImage(img, -img.width/2, -img.height/2);
            ctx.restore();   

            ctx.font = 'bold 13px ÎßëÏùÄÍ≥†Îîï';
            if(this.hero){
                ctx.fillText('ÎßâÎë•Ïù¥', this.x - this.width, this.y-20);
            } else{
                if(_.size(this.name) > 0) {
                    ctx.fillText(this.name, this.x - this.width, this.y-20);
                }
            }
        }

        //Í±∏Ïñ¥Îùº
        forward(){
            this.x+=this.speed;
        }

        //Îõ∞Ïñ¥Îùº
        jumpUp(val){
            this.y-=val;
        }

        //ÎÇ¥Î†§ÏôÄÎùº
        jumpDown(val){
            this.y+=val;
        }

        //Ï†êÌîÑÌï† Í≤∞Ïã¨
        jumpingDecision(){
            if(!this.IsJumping){
                this.jumpSwitch = true;
                this.jumpPoint = _.random(80, 500);
                this.speed = _.random(1, 4);
                this.lucky = _.random(1,10) % 2 == 0;
                this.superLucky = _.random(1, 1000) % 10 == 0;

                pikalabel.innerText = '‚ö°'; //Î∞±ÎßåÎ≥ºÌä∏
                //console.log('‚ö°');
            }
        }
    }

    //ÌîºÏπ¥Ï∏Ñ ÌÅ¥Î¶≠
    // canvas.addEventListener('click', function(e){
    //     const x = e.offsetX;
    //     const y = e.offsetY;
    //     const pixel = ctx.getImageData(x, y, 1, 1);
    //     //console.log(pixel.data[3]);
    //     if(pixel.data[3] != 0){
    //         //console.log('image');
    //         pika.jumpingDecision();
    //     }
    // });
    
    const randomHexColor = () => {
                    const red = _.padStart(_.random(0, 255).toString(16), 2, '0');
                    const green = _.padStart(_.random(0, 255).toString(16), 2, '0');
                    const blue = _.padStart(_.random(0, 255).toString(16), 2, '0');
                    return `#${red + green + blue}`;
    };

    //ÌîºÏπ¥Ï∏Ñ Îì±Ïû•
    var pikas = [new Pikachu()]; //new Pikachu();

    //ÌîºÏπ¥Ï∏Ñ Ï∂úÎèô
    function animate(){
        requestAnimationFrame(animate);
        timer++;
        
        ctx.clearRect(0,0, canvas.width, canvas.height);

        if(_.findLast(pikas).superLucky) {
            let newPika = new Pikachu();
            newPika.hero = true;
            pikas[_.size(pikas) - 1].hero = false;
            newPika.name = '';
            pikas = _.concat(pikas, newPika);
        }
        _.map(pikas, (pika, idx) => {

        
            if(pika.x > canvas.width){
                pikas[idx].x = 0 - pika.width;
            }

            if(timer % pika.jumpPoint == 0){
                // console.log('ÌîºÏπ¥ÌîºÏπ¥', timer);
                pika.jumpingDecision();
            }

            if(pika.jumpSwitch){
                if(pika.y >= 10){
                    pika.IsJumping = true;
                    pika.jumpUp(3);
                    pika.jumpTimer++;
                    
                    // console.log('Ï†êÌîÑÏ§ë',pika.y, jumpTimer);
                }
            }

            if(pika.IsJumping && pika.jumpTimer >= 17 ){
                pika.jumpSwitch = false;
                // console.log('Ï†êÌîÑÎÅù', pika.y, jumpSwitch);

                if(pika.y < 60){
                    pika.jumpDown(3);
                } else{
                    pika.IsJumping = false;
                    pika.jumpTimer = 0;
                    pikalabel.innerText = '';
                }
            }

            //ÏïûÏúºÎ°ú Í∞ÄÍ∏∞
            pika.forward();

            //Îí§Îö±Îí§Îö± Ïä§ÌÖùÎ∞üÍ∏∞
            if(!pika.jumpSwitch && !pika.IsJumping && timer % 10 == 1){
                if(pika.y <= 60){
                    pika.jumpDown(2);
                } else{
                    pika.jumpUp(2);
                }
            }

            //ÌîºÏπ¥Ï∏Ñ Ïö¥ Ï¢ãÏùÑ ÎïåÎßå ÎèåÎ©¥ÏÑú Ï†êÌîÑÌï®
            if(!pika.IsJumping || !pika.lucky){
                pika.draw();
            } else{
                pika.rotate();
            }

        });
    }

    animate();
</script>
</html>